name: Deploy and Release

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: deploy using ssh
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          command_timeout: 20m
          script: |
            set -e
            sudo apt-get install ca-certificates -y
            cd maximilien
            echo "--> Pulling latest code..."
            git fetch origin
            git reset --hard origin/master
            git clean -df
            echo "--> Creating .env file..."
            echo "ACCESS_TOKEN_SECRET='${{ secrets.ACCESS_TOKEN_SECRET }}'" > .env
            echo "PORT='${{ vars.PORT }}'" >> .env
            echo "DB_NAME='${{ vars.DB_NAME }}'" >> .env
            echo "MONGODB_URI='${{ secrets.MONGODB_URI }}'" >> .env
            echo "CORS_ORIGIN='${{ vars.CORS_ORIGIN }}'" >> .env
            echo "R2_ACCESS_KEY_ID='${{ secrets.R2_ACCESS_KEY_ID }}'" >> .env
            echo "R2_SECRET_ACCESS_KEY='${{ secrets.R2_SECRET_ACCESS_KEY }}'" >> .env
            echo "R2_BUCKET_NAME='${{ vars.R2_BUCKET_NAME }}'" >> .env
            echo "R2_ENDPOINT='${{ vars.R2_ENDPOINT }}'" >> .env
            echo "--> Creating frontend .env file..."
            echo "REACT_APP_API_URL='https://maliemaxtitus.fr/'" > frontend/.env
            echo "REACT_APP_NOMINATIM_API_URL='https://nominatim.openstreetmap.org/search'" >> frontend/.env
            echo "REACT_APP_TILE_PROVIDER_URL='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'" >> frontend/.env
            echo "--> Installing dependencies..."
            npm i;
            echo "--> Installing frontend dependencies..."
            npm i --prefix frontend;
            echo "--> Building frontend..."
            npm run build --prefix frontend;
            echo "--> Restarting application with PM2..."
            # Ensure the app is started, then restart it to apply changes.
            # The '|| true' ensures the script doesn't fail if the app doesn't exist yet.
            pm2 delete maximilien-api || true
            pm2 start ecosystem.config.js --env production
            echo "--> Deployment complete."

  release:
    name: Release
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Generate version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          major_pattern: "${{vars.GIT_SEMANTIC_VERSION_MAJOR_PATTERN}}"
          minor_pattern: "${{vars.GIT_SEMANTIC_VERSION_MINOR_PATTERN}}"
          version_format: "${major}.${minor}.${patch}"
          tag_prefix: "v" # It's a good practice to prefix tags with 'v'
      - name: Check if release already exists
        id: check_release
        run: |
          if gh release view ${{ steps.version.outputs.version }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Release and Tag
        if: steps.version.outputs.changed == 'true' && steps.check_release.outputs.exists != 'true'
        run: |
          gh release create ${{steps.version.outputs.version}} --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
